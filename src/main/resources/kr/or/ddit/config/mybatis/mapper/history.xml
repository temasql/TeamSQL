<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="history">
		
	<!-- DB계정명,마지막변경일 리스트 -->
	<select id="changedList" parameterType="String" resultType="historyVo">	
		select object_owner,
		       max(exec_dtm) exec_dtm
		from DDL_HISTORY, crew c
        where c.USER_ID_FK = #{user_id}
		group by object_owner
        order by exec_dtm desc
	</select>
	
	<!-- DB계정명,마지막변경일 페이징리스트 -->
	<select id="changedPagingList" parameterType="map" resultType="historyVo">
		<![CDATA[
		select *
		from
		(select a.*, rownum rn
		from
		(select object_owner,
		       max(exec_dtm) exec_dtm
		from DDL_HISTORY, crew c
        where c.USER_ID_FK = #{user_id}
		group by object_owner
        order by exec_dtm desc)a)
        where rn >= (#{page}-1) * #{pageSize} + 1 and rn <= #{page} * #{pageSize}
        ]]>
	</select>
	
	<!-- DB변경 상세 리스트 -->
	<select id="changedDetailList" parameterType="String" resultType="historyVo">	
		select action_event,
		       object_type,
		       object_name,
		       sql_text,
		       exec_dtm
		from DDL_HISTORY 
        where object_owner = #{object_owner}
        order by exec_dtm desc
	</select>
	
	<!-- 	DB계정 전체수 조회 -->
	<select id="accountCnt" parameterType="String" resultType="int">
		select COUNT(*)
		from crew
		where user_id_fk = #{user_id_fk}
	</select>
	
	<!-- 	DB변경이력 전체수 조회 -->
	<select id="historyCnt" parameterType="String" resultType="int">
		select count(*)
		from ddl_history
		where object_owner = #{object_owner}
	</select>
	
	<!-- DB계정 상세 변경 페이징 리스트 -->
	<select id="changedDetailPagingList" parameterType="map" resultType="historyVo">
		<![CDATA[
		select *
			from
			(select a.*, rownum rn
			from
			(select action_event,
	              object_type,
	              object_name,
	              sql_text,
	              exec_dtm
        	from DDL_HISTORY 
        	where object_owner = #{object_owner}
        	order by exec_dtm desc)a)
		where rn >= (#{page}-1) *#{pageSize} + 1 and rn <= #{page}*#{pageSize}
		]]>
	</select>
	
	<!-- DB계정, 마지막 변경일시, DB계정 생성자 조회 -->
	<select id="changedMainList" parameterType="String" resultType="changedVo">
	<![CDATA[
		select *
		from
        (SELECT  C.OBJECT_OWNER
			   ,  MAX(EXEC_DTM)exec_dtm
			   , (SELECT USERS.USER_NAME FROM ACCOUNT E, USERS WHERE C.OBJECT_OWNER = UPPER(E.ACCOUNT_ID) AND E.USER_ID_FK = USERS.USER_ID) USER_NAME
		FROM
				(SELECT A.OBJECT_OWNER, A.EXEC_DTM
			   	FROM DDL_HISTORY A, (SELECT * FROM CREW WHERE USER_ID_FK = 'gilho2')B
				WHERE A.OBJECT_OWNER = UPPER(B.ACCOUNT_ID_FK) )C, ACCOUNT D
		WHERE C.OBJECT_OWNER = UPPER(D.ACCOUNT_ID)
        GROUP BY C.OBJECT_OWNER
        order by exec_dtm desc)
		where rownum <=7
		]]>
	</select>
	

</mapper>